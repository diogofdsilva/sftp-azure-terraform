# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
    - master
    
pool:
    vmImage: 'ubuntu-latest'

variables:
    - name: AZURE_LOCATION
      value: eastus 
    - group: ARM_AZURE_PRINCIPAL

steps:
- script: |
    az login --service-principal --username $(ARM_CLIENT_ID) --password $(ARM_CLIENT_SECRET) --tenant $(ARM_TENANT_ID)
    az account set --subscription $(ARM_SUBSCRIPTION_ID)
  displayName: 'Login on Azure CLI'

- script: terraform init
  workingDirectory: ./1-terraform
  displayName: 'SETUP: Run Terraform Init'

- script: terraform apply -auto-approve
  workingDirectory: ./1-terraform
  env:
    TF_VAR_AZURE_LOCATION: $(AZURE_LOCATION)
  displayName: 'SETUP: Run Terraform Apply (target=file share)'